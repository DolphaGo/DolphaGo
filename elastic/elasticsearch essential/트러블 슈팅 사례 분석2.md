# 문제 상황 파악

1. **클러스터에 갑자기 문서가 색인이 되지 않아요**
2. **클라이언트에서 403 Forbidden Error가 발생합니다.**

Disk Usage가 꽉 찼을 때 확인을 해봅시다.

# 원인 분석

노드의 디스크 사용량이 100%가 되면, 노드의 운영 체제도 정상적으로 동작하지 않기 때문에 **ElasticSearch에는 디스크 사용량이 일정 수준 이상이 되면 더이상 색인하지 않도록 하는 보호 장치가 있습니다.**

그 보호장치가 바로...

`cluster.routing.allocation.disk.threshold_enabled` 입니다.

이 값을 사용하지 않으면, ES가 100%를 써버리기 때문에 무조건 사용하도록 세팅을 합니다.

![](/images/2024-06-02-16-42-36.png)

노드들끼리 디스크 사용량은 비슷할 텐데, 다른 샤드로 옮기게 되면, 서로 다른 노드로 옮기는 진풍경이 보여질 것입니다...

95%가 넘어버리면 더이상 색인을 하지 않거나 403 포비든 에러가 발생합니다.

# 문제 해결

데이터 노드를 증설하거나, 불필요한 인덱스를 삭제해서 디스크 공간을 확보합니다.

그런데 왜 403 에러가 뜨는 걸까요?

아까전에 디스크 사용량이 일정 수준이 넘어가게 되면, 더이상 색인을 하지 않도록 한다고 했습니다. (보호 장치로서)
그 때 모든 인덱스를 read-only로 바꾸게 되는데, 색인을 하려고 시도를 하니까 Forbidden error가 나는 것입니다.

![](/images/2024-06-02-16-46-07.png)

디스크 확보한 다음에, 그 read-only로 바뀐 것이 자동으로 풀리지가 않습니다. 위와 같이 settings PUT API를 통해서 인덱스들을 명시적으로 풀어줘야 합니다. 그래야 다시 그 인덱스들이 색인을 할 수 있어요.

> 정리

![](/images/2024-06-02-16-47-41.png)
