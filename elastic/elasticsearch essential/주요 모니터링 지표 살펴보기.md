# 모니터링의 기본

이상 징후를 **감지**하고, 필요한 정보를 바탕으로 **전파**하는 것

## 모니터링 시스템 구축

- 어떤 도구로 모니터링할 것인가?

| 시스템 종류                               | 추천하는 모니터링 도구     |
| ----------------------------------------- | -------------------------- |
| elastic cloud, self-hosted elastic search | kibana 의 stack monitoring |
| aws opensearch service                    | aws cloudwatch             |

프로메테우스, 익스포터 조합도 괜찮다.

스택모니터링은 키바나에서 기본적으로 제공하는 모니터링이기 때문에 쉽게 볼 수 있습니다. searchRate, searchLatency..., Slack connector 를 연결해서 alert을 쏴준다거나..


AWS CloudWatch 도 다음과 같이 볼 수 있습니다.
sns topic 과 chatbot을 이용해서 알람을 쏠 수 있는 파이프라인 구성도 가능하다.


## 어떤 지표를 모니터링 할 것인가

- 클러스터를 모니터링 할 수 있는 지표는 무척 많습니다.
- 이렇게 많은 지표들 중에서도 지표들 간의 중요도는 서로 다릅니다.
- 지표들이 어떤 의미를 가지는지, 어떤 지표를 중점적으로 모니터링해야하는 지 기준을 잡는 것이 중요합니다.
- 지표들은 크게 임계치를 걸어서 알람을 받아야 하는 지표와 문제 원인을 찾아내기 위해 분석용도로 사용하는 지표로 나뉩니다.

![](/images/2024-06-02-16-04-20.png)

- 주황색 : 알람을 받을 때 사용하는 지표들
- 녹색 : 문제 원인을 파악할 때 사용하는 지표들

먼저 알람을 받아야하는 지표들을 살펴보겠습니다.

1. CPU Usage

![](/images/2024-06-02-16-05-22.png)


**노드가 얼마나 바쁘냐** 를 직접적으로 알려주는 지표.

2. Disk Usage (Disk Free space)

![](/images/2024-06-02-16-06-14.png)

3. Load

![](/images/2024-06-02-16-06-59.png)

- CPU Usage 와 관련이 있다.
- 얼마나 많은 CPU와 디스크 연산을 처리하고 있는가?
- 프로세스의 개수가 얼마인가?
- 노드 하나에 CPU가 4개가 있다. 근데 load가 1이다. 그럼 4개 중 3개의 cpu가 남은 거라고 볼 수 있다.

4. JVM Heap

![](/images/2024-06-02-16-08-01.png)

5. Threads

![](/images/2024-06-02-16-08-36.png)

스택 모니터링에서 볼 수 있는 지표.

(처리량을 넘어선 요청이 들어오면 리젝..! 하는 상황이 발견된다면 노드가 처리하는 양이 너무 많은 걸 수도 있다.)

![](/images/2024-06-02-16-09-59.png)


이제 우리가 힌트를 얻어야하는 지표들을 확인해봅시다.

1. Memory Usage

노드가 4GB를 차지하고 있다면, JVM heap memory는 3GB로 잡아야 한다. (노드의 물리적인 메모리양을 넘을 수는 없으니)

![](/images/2024-06-02-16-12-38.png)

그래서 Memory Usage는 힙메모리 이슈를 해결할 수 있을 지 확인하는 중요한 지표가 됩니다.

2. Disk I/O

![](/images/2024-06-02-16-13-19.png)

I/O 오퍼레이션이 많아진다는 것은, 성능에 악영향.

디스크 I/O가 너무 많을 수 밖에 없으면, 디스크를 더 좋은 것(SSD 등)으로 쓸 수도 있겠지요.

3. GC Rate

![](/images/2024-06-02-16-15-03.png)

- Old / Young GC가 얼마나 일어나는 지 확인하기 위한 지표.
- 횟수이고, 이 값은 상대적이기 때문에 알람은 아니고 참고하는 용도로 좋다.

4. GC Duration

![](/images/2024-06-02-16-15-34.png)

GC의 소요시간

5. Latency

![](/images/2024-06-02-16-16-47.png)

색인이 느린 것 같다 -> 우리 인덱스 레이턴시가 어떤가? -> -> 1~2초네 -> 어라 색인이 느려졌네 -> 디스크일까, 힙메모리일까.. 등등 첫 번째로 확인하는 지표가 될 것이다.


6. Rate

![](/images/2024-06-02-16-17-36.png)


![](/images/2024-06-02-16-18-29.png)