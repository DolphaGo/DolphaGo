# 문제 상황 파악

**"샤드 배치가 되지 않아요."**

# 원인 분석

- 노드들이 가지고 있을 수 있는 전체 샤드의 개수에는 제한이 존재합니다.
- 그리고 이 제한을 넘어가면 더 이상 샤드가 생성되지 않고 인덱스 생성도 불가능해집니다.

- cluster.max_shards_per_node (Default: 1000)
- 클러스터 안에 샤드들을 가질 수 있는 개수는 기본으로 1000개라는 의미.


![](/images/2024-06-02-16-58-45.png)

위의 상화엥서는 매일 총 10개의 샤드가 생성됩니다.
만약 1년간 로그를 유지하면, 10*365 = 3650개의 샤드가 생성됩니다. 만약 데이터 노드의 개수가 3개라면?

어느날 갑자기 샤드가 생성이 안될 것입니다. (최대 개수를 넘어서)

# 문제 해결

1. 데이터 노드 증설
   1. 노드를 늘려서, 샤드를 스프레드 시키자.
   2. 3650/3 대신에 3650/4로 하면 1000개를 넘지 않으니..!
2. 인덱스 설정 변경
3. cluster.max_shards_per_node 변경

여기서 인덱스 설정을 변경하는 걸 확인해볼까

![](/images/2024-06-02-17-00-52.png)


이렇게 하면, 매일 6개의 샤드가 생성됩니다.  6*365=2190개의 샤드가 생성되고, 데이터 노드 3대가 각각 가지게 될 샤드의 수는 730개가 됩니다. 만약 이렇게 해도 성능이 잘 나오면, 좋은 선택이지요.

물론 위의 3번의 방법처럼 cluster에서 생성할 수 있는 최대 샤드의 개수를 변경하는 것도 방법이겠습니다.

![](/images/2024-06-02-17-02-27.png)

가능은 하지만, 노드에 너무 많은 샤드가 배치되어서 발생할 수 있는 사이드 이펙트가 있기 때문에 권고하진 않습니다.
(사이드 이펙트: CPU가 커지거나 디스크가 커지거나 힙메모리가 커지거나)


> 정리

- es는 노드당 가질 수 있는 샤드의 개수에 제한이 있습니다.
- cluster.max_shards_per_node 를 통해 설정할 수 있으며 기본값은 1000
- 이 값을 초과할 경우 더이상 샤드가 배치되지 읺습니다.
- 데이터 노드를 증설하거나, 생성되는 샤드의 개수를 조절함으로서 대응할 수 있습니다.
- cluster.max_shards_per_node 값을 변경할 수 있으나 권고하진 않습니다.