# 문제 상황 파악

**간헐적으로 색인 과정에서 일부 문서가 누락돼요.**

평상시에는 잘 색인이 되다가, 특정한 시기에 일부 문서가 누락이 되는 것 같다.

-> 간헐적인 누락이기 때문에 문제 상황을 파악하는 것도 어려웠을 것이다.

**"노드에서 간헐적으로 Rejected 에러가 발생합니다."**

-> 이 상황에서는 문서 색인이 안되는 상황이 발생합니다.

# 원인 분석

- ES에는 색인/검색 요청을 처리하는 스레드가 존재합니다.
- 그리고 스레드가 모두 요청을 처리하고 있을 때를 대비해서 큐도 존재합니다.
- 하지만 모든 큐가 꽉 차있다면?
  - **`이 때, Rejected Error가 발생합니다.`**

# 문제 해결

1. 데이터 노드 증설
   1. 클러스터가 처리 가능한 처리량을 높여주기
   2. 물론 이 과정에서 샤드의 적절한 분배가 되어야 노드를 늘리는 것의 의미가 있습니다.
2. 큐 증설
   1. 근본적으로 데이터 노드를 늘려서 처리량을 늘리는 것이 아니라 큐 증설로 임시적으로 늘릴 수 있는 방법
   2. 제한적인 방법으로 늘리는 방법
   3. 즉, 평상시에는 처리량이 괜찮다가, 순간적으로 이벤트로 인해서 튀는 경우가 있을 수도 있다. 월드컵을 위해서 데이터 노드를 늘릴 수도 있겠지만, 굳이 데이터 노드를 늘려야할 필요가 있을까 싶을 땐 큐 증설을 고려해볼 수 있다.

![](/images/2024-06-02-16-53-47.png)

![](/images/2024-06-02-16-55-09.png)

큐 증설로도 스파이크성 트래픽을 처리할 수 있음

![](/images/2024-06-02-16-56-16.png)