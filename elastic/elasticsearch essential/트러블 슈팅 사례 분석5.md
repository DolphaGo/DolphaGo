# 문제 상황 파악

"CMS GC 환경에서 너무 잦은 Old GC가 발생해요"

GC -> Stop the world

![](/images/2024-06-02-17-20-23.png)

2.6s 동안 노드 하나가 oldGC 때문에 멈췄던 상황
이러한 상황이 간헐적으로 반복되던 클러스터였다.

# 원인 분석

- 불필요하게 많은 객체들이 Old 메모리 영역으로 이동하기 때문에 잦은 Old GC가 발생합니다.
- 이는 JVM 의 문제였습니다.

![](/images/2024-06-02-17-21-38.png)

객체가 최초로 만들어져서 Eden -> S0 <-> S1 -> Old 로 들어갑니다. (Eden ~ S0 S2) 를 마이너 GC (Young GC) 라고 하고, Old 영역에서의 GC를 메이저 GC(Old GC)라고 합니다. 메이저 GC에서가 성능이 영향을 직접적으로 주는 부분입니다.

![](/images/2024-06-02-17-22-57.png)

![](/images/2024-06-02-17-23-14.png)

S0, S1로 들어갈 수 없는 상황이라면? Old로 바로 이동하게 되는데, Old 영역에 기존에는 S0, S1에서 오래 살아남은 객체만 이동이 되었던 기존과 달리 너무 잦은 객체가 유입된다.

즉, Surviver 영역이 너무 작아서 생길 수 있는 문제일 것이다.

# 문제 해결

Survivor 영역을 늘려줍니다.

- NewRatio와 SurvivorRatio 로 튜닝한다.

![](/images/2024-06-02-17-24-35.png)

![](/images/2024-06-02-17-25-03.png)

기존 Old 영역 27GB -> 75% 일 때 GC가 발생하겠지만
지금은 Old가 20GB 로 줄었기 때문에 80%일 때 GC 발생하게 끔 같이 튜닝을 진행해주면 좋다.

![](/images/2024-06-02-17-26-43.png)

> 정리

- CMS GC를 사용할 경우 Old GC 에 의해 성능에 영향을 받을 수 있습니다.
  - 요즘은 G1GC를 쓰고 있어서 이 내용이 해당하지 않을 수 있습니다.
- Survivor 영역이 작아서 Eden 영역의 객체들이 이동하지 못하고 Old 영역으로 바로 이동할 수 있고, 이로 인해 불필요하게 Old 영역에 객체들이 많이 생성될 수 있습니다.
- NewRatio와 SurvivorRatio 튜닝을 통해서 Eden 과 Survivor 영역을 늘려주고 이를 통해 문제를 해결할 수 있습니다.