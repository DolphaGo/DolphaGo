# 인덱스란?

| Elasticsearch | RDBMS    |
| ------------- | -------- |
| index         | database |
| mapping       | scheme   |
| document      | row      |


인덱스란, 문서가 저장되는 논리적인 공간
- 문서를 저장하기 위해서는 반드시 인덱스가 존재해야 합니다.
**인덱스를 설계**하는 것이, Elasticsearch 를 사용하기 위해 고려해야 하는 첫 단계입니다.

만약, 도서관 자료 검색 시스템을 만든다고 가정한다면...

> 인덱스(index) 설계

ex) 설계 상황은 다음과 같은 것이 있을 수 있다.

1. library : library 라는 이름의 인덱스를 만들어서 모든 자료를 여기에 저장할 것이냐
   1. 이렇게 되면, type으로 'type: book, type: magazine' 등으로 구분해야할 것이다.
2. book, magazine, multimedia, etc: 각 자료 별로 인덱스를 따로 만들어서 저장할 것이냐

고려해야할 점은, 사용 패턴과 문서의 특성에 따라 설계해야 합니다.


| 케이스                    | 장점                                                        | 단점                                                         |
| ------------------------- | ----------------------------------------------------------- | ------------------------------------------------------------ |
| 하나의 인덱스를 사용할 때 | 관리해야 할 인덱스의 수가 적어 관리 리소스가 적게 발생한다  | 쿼리와 문서의 구조가 복잡해질 수 있다                        |
| 여러개의 인덱스로 나눌 때 | 각가그이 경우에 최적화된 쿼리와 문서 구조를 사용할 수 있다. | 관리해야 할 인덱스의 수가 많아 관리 리소스가 발생할 수 있다. |


> **인덱스 설계**

먼저, 하나의 인덱스로 단순하게 시작한다.
그리고, 사용 패턴에 따라 인덱스를 별도로 운영하는 식으로 **확장**하는 방식이 좋다.

# 샤드(shard)란

- 인덱스에 색인되는 문서가 저장되는 공간
- 하나의 인덱스는 반드시 하나 이상의 샤드를 가집니다.

> 샤드의 종류

| 종류            | 역할                                                                                                                       |
| --------------- | -------------------------------------------------------------------------------------------------------------------------- |
| 프라이머리 샤드 | 문서가 저장되는 원본 샤드, 색인과 검색 성능에 모두 영향을 줌                                                               |
| 레플리카 샤드   | 프라이머리 샤드의 복제 샤드, 검색 성능에 영향을 줌. 프라이머리 샤드에 문제가 생기면 레플리카 샤드가 프라이머리 샤드로 승격 |

c.f.) 색인 과정에는 분석이 포함이 되어 있는데, 그 중 가장 많이 CPU 를 사용하는 부분이 분석하는 부분이다.


## 샤드 설정

```
PUT /library/_settings
{
    "index": {
        "number_of_shards": 5,
        "number_of_replicas": 2
    }
}
```
**number_of_shards <- 프라이머리 샤드를 의미한다. number_of_replicas 는 그 프라이머리 샤드 당 몇 개의 레플리카를 둘 지를 의미한다.**

- 프라이머리 샤드는 5개 
- 레플리카 샤드는 10개 (number_of_shards * number_of_replicas)
- 인덱스의 총 샤드 개수는 15개

## 샤드(shard) 라우팅

- 문서가 샤드에 저장되는 순서를 의미한다.

**`라우팅 룰 = 문서의 ID % 샤드의 개수`**

샤드의 개수가 바뀐다면, 문서가 저장되는 규칙이 완전히 바뀌게 됩니다.

**따라서, 인덱스를 생성할 때 프라이머리 샤드의 개수를 설정하는 것은 매우 중요합니다.**

**-> 왜냐? 바꿀 수가 없기 때문입니다.**

**`number_of_shards` 의 기본값은 1입니다.**
- 하지만, 이 값을 그대로 사용하면 성능에 큰 영향을 미칩니다.
- 7버전부터 기본 값이 1로 지정됨.


# 인덱스(index) 템플릿

인덱스 템플릿을 이용해서 프라이머리 샤드, 레플리카 샤드를 지정해놓는 것도 방법이다.

ex)

```
PUT _index_template/base_template
{
    "index_patterns": ["dolphago-logs-*"],
    "template": {
        "settings": {
            "number_of_shards": 3,
            "number_of_replicas": 2
        }
    }
}
```

`dolphago-logs-`로 시작하는 모든 인덱스는 프라이 머리 샤드 3개, 레플리카 샤드 6개로 생성된다.


> 정리

1. 인덱스는 문서가 저장되는 논리적인 공간, 샤드는 인덱스에 색인되는 문서를 저장하는 공간
2. 인덱스 설계는 es를 사용하기 위해 가장 먼저 고려되어야 합니다.
3. 프라이머리 샤드는 문서가 저장되는 원본 샤드, 레플리카 샤드는 프라이머리 샤드의 복제 샤드입니다.
4. 문서가 라우팅되는 규칙은 (문서의 ID)%(샤드의 개수) 이기 때문에 **인덱스 생성 이후 프라이머리 샤드 개수 변경은 불가합니다.**
5. 인덱스 템플릿을 통해 인덱스 생성 시의 샤드 개수를 미리 설정할 수 있습니다.
