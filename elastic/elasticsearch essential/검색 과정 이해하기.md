inverted index 생성 : 검색


# 검색 과정

- 검색 과정 -> inverted index 검색 -> 검색 결과 표시

과연 inverted index가 무엇일까?

- **문자열을 분석한 결과를 저장하고 있는 구조체**

![](/images/2024-05-30-03-34-55.png)

왼쪽의 문서를 분석해서 우측의 token 으로 분리해서 저장된다.

inverted index 를 어떻게 만드는 지에 대한 과정들을 이해해야 한다.

inverted index 를 구성하는 과정에서 꼭 이해해야 하는 것이 바로 애널라이저(Analyzer)

![](/images/2024-05-30-03-36-36.png)

- character filter : 특수 문자
- tokenizer : 공백 나누거나
- token filter : 소문자로 만들거나

애널라이저는 위의 3가지로 구성되는데, 이걸 커스텀하게 만들어서 커스텀 애널라이저 구성도 가능하다.

![](/images/2024-05-30-03-37-38.png)

만약 linux kernel 이라는 문장을 standard 애널라이저로 분석하면 우측의 결과처럼 토큰이 만들어진다.
즉, 내가 사용하는 애널라이저를 지정해서 분석하려는 텍스트를 지정한다음 우측과 같이 결과를 확인할 수도 있다는 것이다

![](/images/2024-05-30-03-38-40.png)


그렇다면, 이제 검색 과정을 확인해볼까?

![](/images/2024-05-30-03-40-04.png)

`/_analyze` api를 이용해서 내가 원하는대로 토크나이징이 잘 되고 있나 확인하는 것이 검색 과정을 이해하는 데에 많은 도움을 줍니다.

**검색 요청은 프라이머리 샤드와 레플리카 샤드 모두가 처리할 수 있습니다.**

> 검색 과정

데이터 노드는 3개, number_of_shards: 2, number_of_replica: 1 인 상황을 보자.

![](/images/2024-05-30-03-41-35.png)

2번 째 데이터노드는 샤드가 없기 때문에 **클러스터로서의 이점을 활용할 수 없게 됩니다.**

만약에 프라이머리 샤드를 늘려서, 2번째 데이터노드에 프라이머리 샤드를 늘릴 수는 있겠습니다.
그런데, 색인 성능은 충분한데, 검색 성능을 늘리고 싶다고 가정해봅시다.

그럴 때는 프라이머리 샤드 보다는 레플리카 수를 늘려주면 되겠습니다.
(즉, number_of_replicas 를 늘려서 레플리카 샤드를 늘려줍니다.)

![](/images/2024-05-30-03-43-10.png)

즉, 지금 상황은 number_of_shards: 2, number_of_replicas: 2 입니다.

이런 상황에서는 모든 데이터 노드에 쿼리가 가능합니다.
그래서 검색 성능을 높인 것입니다.

이 상황에서 검색 성능을 더 늘리고 싶다면?
-> 데이터 노드를 늘리고, number_of_replica 를 더 늘려주면 됩니다.

number_of_replicas 는 Dynamic 한 값이기 때문에, 운영 중에 언제든지 바꿀 수 있습니다.
운영 중에 추가를 해서 검색 성능을 높일 수 있습니다.

number_of_shards 는 바꿀 수 없습니다. 앞에서 색인 과정에서 살펴본 것처럼, 샤드에 대한 document 라우팅이 바뀌기 때문입니다. 그러나 number_of_replicas 는 변경 가능하기 때문에 검색 성능을 높여줄 수 있다. 이것이 핵심입니다.

검색 성능에 문제가 있다면, 클러스터로서의 이점을 살리고 있는지를 먼저 살펴보아야 합니다.

색인은 가능한한 많은 데이터 노드들이 샤드에 배치가 잘 되어야 합니다.
검색 성능을 클러스터로서의 이점을 잘 살린다는 것은 가능한한 많은 노드들이 검색 성능에 참여를 한다는 것이겠죠.
number_of_replicas:1, number_of_shards: 2 인 상황에서는 데이터 노드를 아무리 늘려봤자, 검색 성능이 늘어나지 않습니다. 데이터 노드를 늘리면서 number_of_replicas 를 같이 늘려주면서 샤드들을 잘 배치해주어야 검색 성능이 같이 증가합니다. 데이터 노드를 추가한다고 해서 단지 검색 성능이 늘어나지 않는다는 것을 잘 기억하시길 바랍니다.

> 정리

- 애널라이저를 통해서 색인 과정에서 문자열을 분석하고, 토큰들이 생성되며, 이 토큰들이 Inverted index 를 구성합니다.
- 애널라이저를 통해 검색어로부터 생성된 토큰들을 inverted index에서 찾는 과정을 검색이라고 합니다.
- 검색 요청은 프라이머리 샤드와 레플리카 샤드 모두에서 처리될 수 있습니다.

- 색인과 검색 모두 적절한 샤드의 수가 성능을 결정하며, 적절한 샤드의 수가 클러스터로서의 이점을 활용하느냐 아니냐를 결정합니다.
- ElasticSearch 는 클러스터로 구성되기 때문에 모든 노드가 색인과 검색을 처리할 수 있도록 구성하는 것이 가장 중요합니다.