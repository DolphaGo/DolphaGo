# 쿼리 컨텍스트와 필터 컨텍스트

- 쿼리 컨텍스트 : 질의에 대한 **유사도를 계산**하여 이를 기준으로 더 정확한 결과를 제공
- 필터 컨텍스트 : **유사도를 계산하지 않고 일치 여부에 따른 결과만을** 반환

> 예시

예를 들어서, `엘라스틱`이 **포함된** 도큐먼트를 찾을 때는 **쿼리 컨텍스트**를 이용하고, 도큐먼트 제목이 정확하게 **엘라스틱**인 문서를 찾기 위해서는 **필터 컨텍스트**를 사용한다.
- 문서 내용에 `엘라스틱`이 포함된 문서를 찾아주세요
  - (쿼리 컨텍스트를 이용) 스코어가 4.5인 문서를 찾았습니다.
-  문서의 제목이 `엘라스틱`입니까?
   - (필터 컨텍스트를 이용) 아닙니다.


<br/>

- 엘라스틱 서치는 쿼리/필터 컨텍스트 방식에 따라 반환하는 결과가 다르다.
  - 쿼리 컨텍스트 : 연관성에 따른 스코어 결과를 제공
  - 필터 컨텍스트 : 예/아니오 결과를 제공


<br/>

- 필터 컨텍스트는 스코어를 계산하기 않기 때문에, 전체적인 쿼리 속도를 올릴 수가 있다.
- 또한, 스코어 계산을 하지 않으면 결과에 대한 업데이트를 매번 수행할 필요가 없기에 캐시를 이용할 수 있다.
- 엘라스틱 서치는 기본적으로 힙 메모리의 10%를 캐시에 이용하는데, 캐시를 이용한 빠른 검색을 하기 위해선 필터 컨텍스트를 이용해야 한다.

> 실습

이제 실습을 해볼 것인데, 우선 엘라스틱에서 제공하는 샘플 데이터를 import하자. (eCommerce sample data)
![](/images/2022-04-03-22-39-35.png)

> 쿼리 컨텍스트 실행
```json
GET kibana_sample_data_ecommerce/_search
{
  "query": {
    "match": {
      "category": "clothing"
    }
  }
}
```
- `_search`는 검색 쿼리를 위해 엘라스틱에서 제공하는 REST API다.
- `match`는 전문 검색을 위한 쿼리로, **역인덱싱된 용어를 검색할 때 사용**한다.
- 위의 쿼리는 `kibana_sample_data_ecommerce` 인덱스에 있는 category 필드의 역인덱스 테이블에 `clothing` 용어가 있는 도큐먼트를 찾아달라는 요청이다.
![](/images/2022-04-03-22-45-35.png)
- `hits.total`은 인덱스에서 3927개의 도큐먼트를 찾았음을 의미한다.
- `hits.hits`는 엘라스틱에서 찾은 3927개의 도큐먼트가 **스코어가 높은 순으로 정렬**되어 있다.
- **쿼리 컨텍스트**는 `유사도 계산 알고리즘`에 의해 가장 연관성 높은 도큐먼트를 찾는다.
- *_score* 값은 요청한 검색과 유사도를 나타내는 지표로, 일반적으로 **값이 클 수록 찾고자 하는 도큐먼트일 확률이 높다.**


> 필터 컨텍스트 실행

```json
GET kibana_sample_data_ecommerce/_search
{
  "query": {
    "bool": {
      "filter":{
        "term": {
          "day_of_week": "Friday"
        }
      }
    }
  }
}
```
- 필터 컨텍스트와 쿼리 컨텍스트 모두 search API를 사용한다.
- 필터 컨텍스트는 **논리(bool) 쿼리 내부의 filter 타입에 적용**된다.
- 위의 쿼리는 kibana_sample_data_ecommerce 인덱스의 day_of_week 필드가 `Friday`인 도큐먼트를 찾아달라는 요청이다.
![](/images/2022-04-03-22-52-09.png)
- 위와 같이 스코어가 계산되지 않고, 0.0으로 나온다.
- day_of_week가 Friday인지만 관심사일 뿐이다.
