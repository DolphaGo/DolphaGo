# 엘라스틱 스택 = (엘라스틱 서치 + 로그 스태시 + 키바나 + 비츠)

- 시각화 - 키바나
- 데이터 저장 & 검색 엔진 - 엘라스틱 서치
- 데이터 수집 - 비츠, 로그스태시

## 엘라스틱 서치 : 분산 검색 엔진
- 검색 엔진이지만, 구글이나 네이버같은 포털 서비스와는 다르다.
- 검색 엔진은 내부적으로 각 도큐먼트를 인덱싱하고 빠르게 검색하는 데 사용하는 기술 -> 우리는 검색 엔진을 이용하여 상위에서 구글, 네이버 같은 서비스를 만들게 된다.
- 엘라스틱 서치는 모든 레코드를 JSON 도큐먼트 형태로 입력하고 관리
- 일반 DB와 마찬가지로, 쿼리한 결과에 대해 일치하는 원본 도큐먼트를 반환한다.
- 텍스트 외에도 숫자, 날짜, IP주소, 지리 정보 등 다양한 데이터 타입에 최적화되어 있음
- **즉, 검색엔진이면서 데이터베이스이기도하고, 텍스트 외에 다양한 데이터 타입을 지원** (일종의 NoSQL 데이터베이스)

- 엘라스틱 서치는 텍스트나 도큐먼트의 경우 인덱싱 시점에 분석을 거쳐 용어 단위로 분해되고 역인덱스 사전을 구축함.
- 숫자나 키워드 타입의 데이터들은 엘라스틱 서치 집계를 위해 집계에 최적화된 컬럼 기반 자료구조를 저장 -> 이렇게 최적화된 자료구조들을 바탕으로 병렬 처리나 분산 처리를 할 수 있음
- 검색엔진으로서 엘라스틱 서치의 중요한 특징 중 하나는 스코어링(scoring), 즉 **연관도에 따른 정렬**
- 단순히 필드 값을 기준으로 한 정렬은 어떤 데이터베이스에서도 제공되나, 엘라스틱서치는 검색어에 대한 유사도 스코어를 기반으로 한 정렬을 제공함. 이는 특히 복잡한 문자열 콘텐츠에서 검색을 수행할 때 큰 효과를 보임
- 루씬은 로우 레벨 검색엔진으로서 코드상에서 자바 라이브러리 형태로 참조해 싸용이 가능함
- 노드간 복제기능 -> 일부 노드가 다운되더라도 정상적으로 서비스를 지속할 수 있음
- 모든 통신을 REST API를 이용하도록 만들어서 프로그래밍 언어와 무관하게 사용자가 쉽게 접근할 수 있도록 활용성을 높였다는 점

#### 단점 
- 저장 공간이 크게 압축되지 않고 시스템 리소스를 많이 사용함
- 엘라스틱서치는 DSL 쿼리를 채용하는데, 조인 쿼리가 어려워서 반정규화를 기본으로 모델링해야함
- 또한 인덱스가 불변의 자료구조라서 도큐먼트를 수정하거나 삭제할 경우 비용이 비쌈


## 키바나 : 시각화와 엘라스틱 서치 관리 도구
- 키바나는 엘라스틱 스택의 UI를 담당
- 엘라스틱서치에 대한 대부분의 관리 기능, API를 실행할 수 있는 콘솔
- 시각화와 대시보드가 핵심
- 라인차트, 파이차트 등과 테이블, 지도 등의 다양한 시각화 요소를 쉽게 만들 수 있음

## 로그 스태시 : 이벤트 수집과 정제를 위한 도구
- 대량의 데이터를 검색하기 위해 가장 먼저 선행되어야 하는 작업은 데이터를 적재하는 것
- 데이터 수집과 가공 기능을 제공
- 로그, 메트릭, 웹 애플리케이션 등 다양한 소스로부터 로그를 수집할 수 있음
- 필터 기능을 이용하여 비정형이나 반정형 데이터를 분석하기 쉬운 형태로 정제할 수 있음
- 엘라스틱 서치 외에도 다양한 플랫폼으로 정제된 데이터를 내보낼 수 있음
- 로그스태시는 형식에 무관하게 데이터를 동적으로 수집, 변환, 전송하는 구조
- 비구조적인 데이터에서 구조를 도출, IP 주소에서 위치 정보 좌표를 해독하고, 민감한 필드를 익명화 하거나 제외시키는 등 전반적인 작업을 쉽게 해줌
- 로그스태시는 별도의 코딩 없이 간단한 설정만으로 로그를 가공 가능
- 확장 가능한 200개 이상의 플러그인 사용법에 대해 알면 되는데 그 난이도 또한 쉽다
- 엘라스틱서치의 인덱싱 성능을 최적화 하기 위한 배치처리와 병렬 처리 가능
- 영속적인 큐를 사용하여 현재 처리 중인 이벤트의 최소 1회 전송을 보장
  

## 비츠 : 엣지단에서 동작하는 경량 수집 도구
- 로그 스태시는 다양한 필터와 설정을 지원하는 만큼 **무겁기 때문에** 실제 서비스가 동작하는 호스트에 수집기를 설치하는 목적으로는 활용도가 떨어진다.
- 이러한 이유로 엘라스틱 스택에는 파일비트, 메트릭 비트 등 비츠라고 부르는 경량수집기가 있음
- 각 비트는 로그 수집, 시스템 지표 수집 등 특정 목적에 최적화된 에이전트
- 가볍기로 유명한 Go programming 언어로 작성되어 있음
- 복잡한 이벤트 가공은 지원하지 않아서 가볍기에 각 서비스 호스트에 부담없이 설치 가능하다.
- 흔히 비츠에서 각 서비스 호스트의 정보를 수집 한 뒤, 로그스태시에서 이를 취합하고 가공한 다음 엘라스틱 서치로 전송하고 이를 키바나로 시각화하는 아키텍처가 많이 사용됨


# 엘라스틱 스택의 용도

## 전문 검색 엔진
- 전문(full text)은 단순한 문장부터 뉴스 기사나 논문 등 다양한 글의 전체 내용을 의미함.
- 단순한 도큐먼트는 일반 DB의 Like 검색하면 되지만, 길어지면 인덱스 없이는 빠른 검색 성능을 내기 어려움
- 빠르고 정확하게 검색하기 위해 전문을 용어(terms) 단위로 분석해 인덱싱해두고 이를 기반으로 검색을 수행하는 역인덱싱(inverted indexing) 기법이 많이 활용된다.


## 로그 통합 분석
- 애플리케이션에서 발생되는 로그는 디버깅에 있어 중요한 요소 중 하나
- 복잡하고 많은 양의 로그는 운영을 위해 사용되는 여러 서비스와 기반 시스템에서도 발생되기 때문에 서비스가 조금이라도 커지면 단순히 여러창에 tail 명령을 이용해 로그를 추적하는 방식은 한계에 부딪힘
- 엘라스틱 스택은 여러 장비와 서비스에서 발생하는 로그들을 통합하고 검색하는 데 최적화된 솔루션
- 시스템과 호스트, 쿠버네티스, 아파치, MySQL, 윈도우 같은 다양한 환경에서 생성되는 로그를 별도의 복잡한 구성 없이도 바로 수집 가능하다.
- 비츠를 사용하여 적은 리소스로 각 장비의 로그들을 빠르게 수집하고, 로그 스태시는 다양한 필터를 통해 일원화된 형태로 가공을 도우며, 엘라스틱서치의 대용량 로그에 대한 빠른 인덱싱 성능과 텍스트 검색 능력은 여러 곳에 흩어진 서비스 로그들을 통합해서 연관 분석을 지원함
- 키바나의 로그 UI나 대시보드는 시계열로 발생하는 로그들을 직관적으로 모니터링할 수 있도록 해준다.

> 로그모니터링
- 파일비트
  - 내장된 모듈을 이용하여 별도 설정 없이 빠르게 로그 수집 가능하게 함
  - 파일비트의 모듈은 알려진 서비스들을 정제하기 위한 파이프라인 설정, 샘플 대시보드 등을 포함하고 있기 때문
  - 로그스태시의 필터 기능이나 엘라스틱서치의 수집 파이프라인 기능으로 정제가 가능
  - 패턴을 기반으로 원문을 가공해 반정형의 텍스트 메시지로부터 정형화된 수치 등의 정보를 뽑아내어 인덱싱하면 훨씬 더 다양한 방식으로 로그 분석이 가능해짐
  - 엘라스틱서치에서는 로그 원문의 빠른 검색 후 하이라이트가 가능함

- 관계형 데이터베이스와 다르게 엘라스틱서치는 인덱스 패턴을 이용해 한 번에 여러 인덱스에서 동시에 조회가 가능
- 이는 복잡한 조인 쿼리 없이도 각기 다른 서비스에서 동시간대에 어떤 로그가 발생했는지 탐색하고 공통된 요소를 찾아 문제의 원인을 분석할 수 있게 해줌
  
## 보안 이벤트 분석, 애플리케이션 성능 분석, 머신 러닝 등에도 활용됨



# 엔터프라이즈 데이터 버스인 카프카와 연동
- 아파치 카프카는 분산 데이터 스트리밍 플랫폼
- 대량의 데이터를 실시간으로 배포하는 데 최적화되어 있어 많은 빅데이터 플랫폼에서 기본적으로 채택
- 카프카와 엘라스틱 스택은 데이터 수집 시점에서 많이 연계되어 사용
- 비츠에서 수집한 각 장비의 이벤트를 카프카로 전송하고 이를 로그스태시로 다시 읽어 들이거나, 카프카에 저장된 다른 시스템의 이벤트를 엘라스틱서치로 읽어 들이는 등의 구성으로 자주 사용됨
- 카프카를 사용하면 엘라스틱서치의 인덱싱 성능이 순간적으로 충분하지 않거나 로그스태시나 엘라스틱서치의 불안정으로 정상적인 인덱싱이 불가능할 때도 데이터의 유실이 방지되며 타 시스템과 데이터 연계가 손쉬워진다는 장점이 있다.


# 하둡 생태계와 연동
- 엘라스틱 스택에서 es-hadoop 모듈을 사용하면 스파크에서 엘라스틱서치 API를 사용해 도큐먼트를 읽어 들이고 반대로 인덱싱하는 등 서로 상호작용을 수행할 수 있음
- 엘라스틱 서치는 이미 인덱싱된 결과에 대해 빠른 검색을 제공하고 스파크는 기존에 인덱싱되지 않은 데이터에 대한 빠른 일괄처리를 제공하기 때문에 엘라스틱서치를 중간 집계 엔진이나 결과를 저장해 재활용하는 용도 등으로 활용할 수 있음.

# 관계형 데이터베이스와 연동
- 관계형 데이터베이스에서는 주로 레거시 데이터나 신뢰성이 중요한 데이터가 있음
- 로그 스태시는 JDBC 입력 플러그인, 필터 등 관계형 데이터베이스와 연계할 수 있는 다양한 방법을 지원함
- 기존 관계형 데이터베이스에 저장된 데이터를 인덱싱하거나 입력받는 이벤트에 정보를 주입하는 등 여러 용도로 사용됨
- JDBC 입력 플러그인을 사용해 관계형 데이터베이스에 저장된 데이터를 엘라스틱 서치로 이전할 경우, 엘라스틱 스택의 우수한 성능을 이용해 관계형 데이터베이스로는 처리하기 어려운 집계도 빠르고 정확하게 처리할 수 있음
- 텍스트 데이터의 경우 엘라스틱서치에서는 색인만 수행하고 원문을 저장하지 않게 설정하는 방식을 이용해서 저장소 용량을 아껴 쓰면서 검색 엔진의 전문 검색 기능만 활용하는 경우도 있음
  