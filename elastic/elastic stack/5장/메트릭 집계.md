- [Metric aggregation](#metric-aggregation)
    - [평균값/중간값 구하기](#평균값중간값-구하기)

# Metric aggregation

- 필드의 **최소/최대/합계/평균/중간값**같은 통계 결과를 보여줌
- 필드의 타입에 따라서 사용 가능한 집계 타입에 제한이 있음
  - 대표적으로 텍스트 타입 필드는 합계나 평균 같은 수치 연산을 할 수 없음


> 메트릭 집계 종류

| 메트릭 집계  | 설명                                                                  |
| ------------ | --------------------------------------------------------------------- |
| avg          | 필드의 평균값 계산                                                    |
| min          | 필드의 최솟값 계산                                                    |
| max          | 필드의 최댓값 계산                                                    |
| sum          | 필드의 총합을 계산                                                    |
| percentiles  | 필드의 백분윗값을 계산                                                |
| stats        | 필드의 min, max, sum, avg, count(도큐먼트 개수)를 한 번에 볼 수 있다. |
| cardinality  | 필드의 유니크한 값 개수를 보여준다.                                   |
| geo-centroid | 필드 내부의 위치 정보의 중심점을 계산한다.                            |

### 평균값/중간값 구하기

- 평균값을 구할 수 있는 평균 집계(avg aggregation)
- 중간값을 구할 수 있는 백분위 집계(percentiles aggregation)


> 평균값을 구하는 집계 요청

```json
GET kibana_sample_data_ecommerce/_search
{
  "size": 0,
  "aggs": {
    "stats_aggs": {
      "avg": {
        "field": "products.base_price"
      }
    }
  }
}
```
-> Response
```json
{
  "took" : 448,
  "timed_out" : false,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 4675,
      "relation" : "eq"
    },
    "max_score" : null,
    "hits" : [ ]
  },
  "aggregations" : {
    "stats_aggs" : {
      "value" : 34.88652318578368
    }
  }
}
````

- 평균 집계(avg)를 이용해 products.base_price 필드의 평균값을 구하는 요청이다.
- 집계 이름 : stats_aggs
- 집계 타입 : avg
- **평균 집계를 사용하기 위해서는 필드 타입이 정수나 실수 타입이어야 한다.**
- 평균값을 구하고 싶은 필드명 : products.base_price
- `"size" : 0` : 집계에 사용한 도큐먼트를 결과에 포함하지 않음 -> 비용 절감 가능
- 평균 가격이 34.8865... 인 것을 알 수 있다.


> 백분위를 구하는 집계 요청

```json
GET kibana_sample_data_ecommerce/_search
{
  "size": 0,
  "aggs": {
    "stats_aggs": {
      "percentiles": {
        "field": "products.base_price",
        "percents": [
          25,
          50
        ]
        
      }
    }
  }
}
```
-> Response
```json
{
  "took" : 107,
  "timed_out" : false,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 4675,
      "relation" : "eq"
    },
    "max_score" : null,
    "hits" : [ ]
  },
  "aggregations" : {
    "stats_aggs" : {
      "values" : {
        "25.0" : 16.984375,
        "50.0" : 25.656941371681416
      }
    }
  }
}
```
- 집계 타입 : percentiles (백분위 집계)
- **백분위 집계는 필드의 특정 백분위에 속하는 데이터를 찾아줌**
  - 그러니, 중간값은 50, 최댓값은 100이라고 볼 수 있다.
  - 예를 들어 percents를 100으로 지정하면, 최댓값인 max와 동일하다.
- 우리는 25%, 50%에 속하는 데이터를 요청한다.