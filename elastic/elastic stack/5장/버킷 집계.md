- [버킷 집계](#버킷-집계)
  - [히스토그램 집계](#히스토그램-집계)
  - [범위 집계](#범위-집계)
  - [용어 집계](#용어-집계)
    - [용어 집계가 정확하지 않은 이유](#용어-집계가-정확하지-않은-이유)
    - [용어 집계 정확성 높이기](#용어-집계-정확성-높이기)

# 버킷 집계

- 버킷 집계는 특정 기준에 맞춰서 도큐먼트를 그룹핑하는 역할
- 여기서 버킷은 도큐먼트가 분할되는 단위로 나뉜 각 그룹을 의미함.
- **특정 목적으로 도큐먼트를 그룹핑하고 싶을 때 버킷집계를 이용**

> 자주 사용하는 버킷 집계 종류

| 버킷 집계         | 설명                                                                                                                                          |
| ----------------- | --------------------------------------------------------------------------------------------------------------------------------------------- |
| histogram         | 숫자 타입 필드를 일정 간격으로 분류                                                                                                           |
| date_histogram    | 날짜/시간 타입 필드를 일정 날짜/시간 간격으로 분류                                                                                            |
| range             | 숫자 타입 필드를 **사용자가 지정하는 범위 간격으로** 분류                                                                                     |
| date_range        | 날짜/시간 타입 필드를 **사용자가 지정하는 날짜/시간 간격으로** 분류                                                                           |
| terms             | 필드에 많이 나타나는 용어(값)들을 기준으로 분류                                                                                               |
| significant_terms | terms 버킷과 유사하나, 모든 값을 대상으로 하지 않고, **인덱스 내 전체 문서 대비 현재 검색 조건에서 통계적으로 유의미한 값들을 기준으로 분류** |
| filters           | 각 그룹에 포함시킬 문서의 조건을 직접 지정. 이때 조건은 일반적으로 검색에 사용되는 쿼리와 동일함                                              |


## 히스토그램 집계

- 히스토그램 집계(histogram aggregation)는 숫자 타입 필드를 일정 간격(interval) 기준으로 구분해주는 집계이다.
  
> 예제

```json
GET kibana_sample_data_ecommerce/_search
{
  "size": 0,
  "aggs": {
    "histogram_aggs": {
      "histogram": {
        "field": "products.base_price",
        "interval": 100
      }
    }
  }
}
```
![](/images/2022-04-12-01-49-51.png)

- 위 결과는 앞서 지정했던 `histogram_aggs`라는 이름으로 집계 결과를 보여준다.
- 100단위로 구분했는데, key가 0은 필드값이 `0~99` 사이 값을 의미한다.
- key가 100인 것은 `100~199` 사이의 값을 의미하는 것이고..
- doc_count는 버킷에 속한 도큐먼트의 개수인데, base_price의 값이 `0~99` 인 버킷에 도큐먼트가 가장 많고, `1000~1099`인 버킷엔 도큐먼트가 1개 있음을 확인할 수 있다.


## 범위 집계

- 히스토그램 집계는 설정은 간단하나, 각 버킷의 범위를 동일하게 지정할 수 밖에 없는 단점이 있다.
- 특히 `0~99`처럼 특정 구간에 데이터가 몰려 있거나 데이터 편차가 큰 경우 모든 데이터를 표현하는데 비효율적인 경우가 있다.
- 범위 집계(range aggregation)을 이용하면, 각 버킷의 범위를 사용자가 직접 설정할 수 있다.

> 예제

```json
GET kibana_sample_data_ecommerce/_search
{
  "size": 0,
  "aggs": {
    "range_aggs": {
      "range": {
        "field": "products.base_price",
        "ranges": [
          {
            "from": 0,
            "to": 50
          },
          {
            "from": 50,
            "to": 100
          },
          {
            "from": 100,
            "to": 200
          },
          {
            "from": 200,
            "to": 1000
          }
        ]
      }
    }
  }
}
```
- 히스토그램 집계랑 사용법이 비슷하지만, 범위를 직접 지정할 수 있다.
- 앞서 `0~200` 사이에 거의 모든 데이터가 있어서, `200~1000` 구간은 하나로 크게 병합하고, 데이터가 많았던 `0~200`을 세분화했다.
- from이 100, to가 200이면, `100 <= value < 200` 을 의미한다.
- 그리고 범위에 따라 도큐먼트 개수가 다른 이유는 `products`가 배열이기 때문이다.
  - 예를 들어서 products.base_price가 [20,70] 값을 갖고 있다고 했을 때 범위가 `0~100`일 때는 1로 카운트가 되고, `0~50`, `50~100으로 세분화가 되면 도큐먼트가 개별로 계산되어 총 합은 2로 나오게 된다.


## 용어 집계

- 용어 집계(terms aggregation)는 필드의 유니크한 값을 기준으로 버킷을 나눌 때 사용된다.

> 예시

```json
GET kibana_sample_data_ecommerce/_search
{
  "size": 0,
  "aggs": {
    "term_aggs":{
      "terms": {
        "field": "day_of_week",
        "size": 6
      }
    }
  }
}
```
- `day_of_week` 필드의 값을 기준으로, 도큐먼트 수가 많은 상위 6개의 버킷을 요청했다.
![](/images/2022-04-12-02-11-01.png)
- size 파라미터는 만들어지는 버킷수를 지정하는데, size를 작성하지 않으면 기본 값으로 10이 적용된다.
- size로 지정한 숫자가 생성되는 버킷보다 작은 경우 size로 지정한 버킷만 보이고 나머지 버킷들은 보이지 않는다.
- 그리고 용어 집계에서만 확인할 수 있는 2개의 특별한 결과값이 있다.
  - `doc_count_error_upper_bound` : 버킷이 잠재적으로 카운트하지 못할 도큐먼트의 수
  - `sum_other_doc_count`: 버킷에는 있지만, size 때문에 보이지 않는 도큐먼트 수
  - 이 예제에서 보이는 579는 현재 버킷에서 보이지 않는 Monday의 개수일 것이다.

### 용어 집계가 정확하지 않은 이유
- 용어 집계에 부정확도를 표시하는 이유는 **분산 시스템의 집계 과정에서 발생하는 잠재적인 오류 가능성 때문**이다.
- **분산 시스템에서는 데이터를 여러 노드에서 분산하고 취합하는 과정에서 오류가 발생할 수 있다.**
- 엘라스틱서치는 `샤드`에 도큐먼트를 저장하고, 이를 분산하는데, size 설정 값과 샤드 개수 등에 의해 집계에 오류가 발생할 수 있다.
- 예를 들어 size가 6이고 샤드1, 샤드2가 있다고 가정해보자
  - 샤드 1에는 토요일 8개, 일요일 4개, 월화수목금 5개
  - 샤드 2에는 토요일 1개, 일요일 7개, 월화수목금 5개
  - 실제 결과는 월,화,수,목,금은 10개, 토요일 9개, 일요일 11개다.
    - 그래서 월,화,수,목,금,**일**이 원하는 결과일 것이다.(상위 6개)
  - 그런데 용어 집계를 하게 되면, 월,화,수,목,금은 10개, 토요일 8개, 일요일 7개가 된다.
    - 그래서 월,화,수,목,금,**토**라고 결과가 나올 것이다.
  - 이와 같은 오류가 나오는 이유가 뭘까?
    - **집계가 모든 도큐먼트를 가져와 한 번에 집계를 하는 것이 아니라, 분산되어 있는 개별 노드단에서 먼저 집계를 하고, 그 결과를 다시 취합해 다시 집계를 하기 때문**이다.
- 이처럼 정확한 값과 다른 결과가 나올 수 있고, 이런 정보가 응답 결과의 `doc_count_error_upper_bound`에 표시된다.


### 용어 집계 정확성 높이기
- 앞서 용어 집계는 분산 시스템 환경에서 오류가 발생할 수 있음을 알고 있음.

> 용어 집계 오류 확인 요청하기

```json
GET kibana_sample_data_ecommerce/_search
{
  "size": 0,
  "aggs": {
    "term_aggs":{
      "terms": {
        "field": "day_of_week",
        "size": 6,
        "show_term_doc_count_error": true
      }
    }
    
  }
}
```

- **`show_term_doc_count_error` 파라미터를 추가해주면 된다.**
  - 이 파라미터를 추가하면, 버킷마다 확인할 수 있다.
- 이 값이 0이라면, 오류가 없다는 뜻이다.
  - 지금은 샤드를 1개만 사용하고 있기도 하고, 대용량 작업도 아니니까 특별한 오류가 나오지는 않을 것이지만 버킷마다 잠재적인 오류 가능성을 확인해볼 수 있다.
- **그래도 만약 오류가 있다면, 다음과 같이 샤드 크기 파라미터를 늘릴 필요가 있다.**

> 용어 집계 시 샤드 크기를 늘린 요청

```json
GET kibana_sample_data_ecommerce/_search
{
  "size": 0,
  "aggs": {
    "term_aggs":{
      "terms": {
        "field": "day_of_week",
        "size": 6,
        "shard_size": 100
      }
    }
    
  }
}
```
- 용어 집계시 `shard_size` 파라미터를 이용해 샤드 크기를 늘릴 수 있는데, **샤드 크기는 용어 집계 과정에서 개별 사드에서 집계를 위해 처리하는 개수를 의미**한다.
- **샤드 크기를 크게하면 정확도가 올라가는 대신 리소스 사용량이 올라가 성능은 떨어질 수 있다는 것을 기억해야 한다.**
- **샤드 크기는 기본적으로 size*1.5+10**으로 계산되는데, 여기서 size는 **버킷의 개수**이다.
  - 즉, 위의 예제로 1.5*6+10 = 19로 샤드 크기가 설정되었을 것이다.