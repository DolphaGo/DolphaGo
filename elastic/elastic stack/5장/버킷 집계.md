- [버킷 집계](#버킷-집계)
  - [히스토그램 집계](#히스토그램-집계)
  - [범위 집계](#범위-집계)

# 버킷 집계

- 버킷 집계는 특정 기준에 맞춰서 도큐먼트를 그룹핑하는 역할
- 여기서 버킷은 도큐먼트가 분할되는 단위로 나뉜 각 그룹을 의미함.
- **특정 목적으로 도큐먼트를 그룹핑하고 싶을 때 버킷집계를 이용**

> 자주 사용하는 버킷 집계 종류

| 버킷 집계         | 설명                                                                                                                                          |
| ----------------- | --------------------------------------------------------------------------------------------------------------------------------------------- |
| histogram         | 숫자 타입 필드를 일정 간격으로 분류                                                                                                           |
| date_histogram    | 날짜/시간 타입 필드를 일정 날짜/시간 간격으로 분류                                                                                            |
| range             | 숫자 타입 필드를 **사용자가 지정하는 범위 간격으로** 분류                                                                                     |
| date_range        | 날짜/시간 타입 필드를 **사용자가 지정하는 날짜/시간 간격으로** 분류                                                                           |
| terms             | 필드에 많이 나타나는 용어(값)들을 기준으로 분류                                                                                               |
| significant_terms | terms 버킷과 유사하나, 모든 값을 대상으로 하지 않고, **인덱스 내 전체 문서 대비 현재 검색 조건에서 통계적으로 유의미한 값들을 기준으로 분류** |
| filters           | 각 그룹에 포함시킬 문서의 조건을 직접 지정. 이때 조건은 일반적으로 검색에 사용되는 쿼리와 동일함                                              |


## 히스토그램 집계

- 히스토그램 집계(histogram aggregation)는 숫자 타입 필드를 일정 간격(interval) 기준으로 구분해주는 집계이다.
  
> 예제

```json
GET kibana_sample_data_ecommerce/_search
{
  "size": 0,
  "aggs": {
    "histogram_aggs": {
      "histogram": {
        "field": "products.base_price",
        "interval": 100
      }
    }
  }
}
```
![](/images/2022-04-12-01-49-51.png)

- 위 결과는 앞서 지정했던 `histogram_aggs`라는 이름으로 집계 결과를 보여준다.
- 100단위로 구분했는데, key가 0은 필드값이 `0~99` 사이 값을 의미한다.
- key가 100인 것은 `100~199` 사이의 값을 의미하는 것이고..
- doc_count는 버킷에 속한 도큐먼트의 개수인데, base_price의 값이 `0~99` 인 버킷에 도큐먼트가 가장 많고, `1000~1099`인 버킷엔 도큐먼트가 1개 있음을 확인할 수 있다.


## 범위 집계

- 히스토그램 집계는 설정은 간단하나, 각 버킷의 범위를 동일하게 지정할 수 밖에 없는 단점이 있다.
- 특히 `0~99`처럼 특정 구간에 데이터가 몰려 있거나 데이터 편차가 큰 경우 모든 데이터를 표현하는데 비효율적인 경우가 있다.
- 범위 집계(range aggregation)을 이용하면, 각 버킷의 범위를 사용자가 직접 설정할 수 있다.

> 예제

```json
GET kibana_sample_data_ecommerce/_search
{
  "size": 0,
  "aggs": {
    "range_aggs": {
      "range": {
        "field": "products.base_price",
        "ranges": [
          {
            "from": 0,
            "to": 50
          },
          {
            "from": 50,
            "to": 100
          },
          {
            "from": 100,
            "to": 200
          },
          {
            "from": 200,
            "to": 1000
          }
        ]
      }
    }
  }
}
```
- 히스토그램 집계랑 사용법이 비슷하지만, 범위를 직접 지정할 수 있다.
- 앞서 `0~200` 사이에 거의 모든 데이터가 있어서, `200~1000` 구간은 하나로 크게 병합하고, 데이터가 많았던 `0~200`을 세분화했다.
- from이 100, to가 200이면, `100 <= value < 200` 을 의미한다.
- 그리고 범위에 따라 도큐먼트 개수가 다른 이유는 `products`가 배열이기 때문이다.
  - 예를 들어서 products.base_price가 [20,70] 값을 갖고 있다고 했을 때 범위가 `0~100`일 때는 1로 카운트가 되고, `0~50`, `50~100으로 세분화가 되면 도큐먼트가 개별로 계산되어 총 합은 2로 나오게 된다.


