- [파일 비트](#파일-비트)
  - [파일비트 아키텍처](#파일비트-아키텍처)
  - [파일비트 다운로드](#파일비트-다운로드)
  - [파일비트 실행](#파일비트-실행)
  - [파일비트 설정](#파일비트-설정)
    - [유용한 설정](#유용한-설정)
      - [ignore_older](#ignore_older)
      - [include_lines](#include_lines)
      - [exclude_lines](#exclude_lines)
      - [exclude_files](#exclude_files)
    - [멀티라인 로그처리](#멀티라인-로그처리)
  - [모듈](#모듈)
    - [비트다운로드](#비트다운로드)
    - [비츠 설정 파일 수정](#비츠-설정-파일-수정)
    - [모듈 활성화](#모듈-활성화)
    - [모듈 설정 파일 수정](#모듈-설정-파일-수정)
    - [setup 명령과 함께 비트 실행](#setup-명령과-함께-비트-실행)
    - [키바나에서 확인](#키바나에서-확인)
---

# 파일 비트
## 파일비트 아키텍처

- 서버나 시스템을 운영하다보면, 수많은 로그들이 파일 형태로 발생한다.
- 파일비트는 이런 로그 파일을 쉽게 수집하도록 도와주며 궁극적으로 엘라스틱과 키바나를 이용해 로그를 추적하고 통계를 만들어 활용할 수 있게 도와준다.
- 파일비트는 Go 언어로 작성되어있고, JVM 같은 무거운 런타임 라이브러리가 따로 필요하지 않아서 가볍기 때문에 수집할 시스템에 부담없이 설치될 수 있다.
- 로그스태시처럼 간단한 필터 작업도 가능하다.

> #### 파일비트 아키텍처 구조 
> [출처](https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-overview.html)


![](/images/2022-04-19-00-05-29.png)

- 파일비트는 다음 3가지 주요 구성 요소로 이뤄져있다.

**1. 입력(input)**

- 설정 파일에서 하베스터에 대한 입력 소스를 정한다.
- 파일비트는 하나 혹은 여러 개의 입력을 가질 수 있다.

**2. 하베스터(harvester)**

- 입력에 명시된 파일을 직접 수집하는 주체다.
- 파일은 하나의 하베스터를 가지며, 하베스터는 파일을 한 줄씩 읽고 내보내는 역할을 한다.
- 또한 파일을 열고 닫는 역할도 한다.
- 하베스터가 실행되는 동안에는 파일 디스크립터가 열려있다.

**3. 스풀러(spooler)**

- 하베스터가 수집한 이벤트를 엘라스틱서치나 로그스태시 같은 장소로 전달한다.


파일비트는 기본적으로 파일에 적재되는 로그들을 가져오는 역할을 한다.
input에서 대상 경로를 모니터링하다가 새로운 파일이 발견되면, 하베스터를 생성해서 해당 데이터를 읽어들인다.



## 파일비트 다운로드

- [7.10.1 버전 다운로드](https://www.elastic.co/kr/downloads/past-releases/filebeat-7-10-1)

## 파일비트 실행

- 파일비트를 다운로드했으면, 이제 원하는 로그 파일을 수집하기 위해 설정 파일을 수정해야 한다.
- 파일비트를 폴더 내에 filebeat.yml 이라는 설정 파일이 있다.
- 설정 가능한 모든 파라미터는 [여기](https://www.elastic.co/guide/en/beats/filebeat/current/configuring-howto-filebeat.html)를 참고해보자.
  - 참고로, heartbeat나 metricbeat를 다운로드하면 heartbeat.yml이나 metricbeat.yml 이라는 이름의 설정 파일이 있고, 온라인 문서에서 설정 파일 사용법을 제공하고 있다.

- filebeat.yml을 다음과 같이 수정한다.

![](/images/2022-04-19-00-22-05.png)
![](/images/2022-04-19-00-23-10.png)
![](/images/2022-04-19-00-40-28.png)

- input은 파일비트가 가져오는 입력, output은 내보내는 출력이다.

> 파일비트 input 타입
- log
  - 가장 기본이 되는 타입으로, 파일시스템의 지정한 경로에서 로그 파일을 읽어 들인다.
- container
  - 도커 같은 컨테이너의 로그를 수집하기 위한 입력으로, 파일을 읽어 들인다는 점에서 log와 유사하다.
- s3
  - log 타입과 유사하나, 아마존 웹 서비스의 s3 버킷에 위치한 파일을 읽어들인다.
- kafka
  - 다른 타입과는 다르게 파일을 읽어들이는 대신 카프카의 토픽을 읽어들인다.


여기서는 input 타입을 log로 지정했는데, log타입은 paths에 지정된 파일의 로그를 한 줄씩 가져오는 것을 의미한다.

paths에 *.log를 가져오고 있기 때문에 logs 폴더에 있는 확장자가 log인 모든 파일을 가져온다.

아웃풋은 하베스터가 읽어들인 데이터를 전달할 곳으로, 엘라스틱서치, 로그스태시, 카프카, 특정 파일, 콘솔 등 여러 형태의 아웃풋 중 하나를 선택할 수 있다.

> 파일비트 output 타입

- elasticsearch
  - 가장 많이 사용되는 타입으로, 수집한 이벤트를 엘라스틱서치로 직접 인덱싱한다.

- logstash
  - 다수의 비츠를 사용해 엘라스틱서치로 전송되는 인덱싱 리퀘스트의 양이 많거나, 비츠나 인제스트 노드 수준에서 처리하기 어려운 가공 작업이 필요할 때 별도의 로그스태시를 구축한 후, 수집한 이벤트를 전송한다. 다수의 인덱싱 요청이 로그스태시에서 단일 벌크 리퀘스트로 묶여 인덱싱 효율의 개선을 기대할 수 있다.
  - 이때 전송한 이벤트는 로그스태시의 beats input을 이용해 입력받을 수 있다.

- kafka
  - 파일비트에서 1차적으로 수집한 이벤트를 카프카로 전송한다.
  - 카프카는 좀 더 안정적인 수집 파이프라인을 구성할 때 신뢰할만한 중간 저장소/큐이므로 수집 중 장애 발생 시 데이터 손실을 최소화하기 위한 방안으로 활용된다.
  - 최종적으로 엘라스틱서치의 인덱싱을 원할 경우 이후 다시 파일비트의 카프카 인풋을 이용하거나, 로그스태시의 카프카 인풋을 이용해 입력할 수 있다.

- console
  - 수집한 이벤트를 시스템 콘솔에 출력한다.
  - 일반적으로 수집이 정상적으로 이뤄지는지 입력 설정을 테스트하기 위한 목적으로 사용된다.

우리가 예제로 설정한 것처럼, elasticsearch를 아웃풋으로 지정하면, 반드시 엘라스틱서치 호스트 주소(hosts)를 적어야 한다.

마지막으로, `setup.kibana`를 지정하면 키바나 대시보드에서 파일비트 데이터를 확인할 수 있다.

이제 파일 비트를 실행해보자.
```sh
./filebeat setup -e
```

- 파일비트를 실행하기 전에 setup 옵션을 실행한다. `-e`는 모니터에 오류나 로그를 보여주는 옵션이다.
- 혹시나 실행이 안된다면, [여기](https://github.com/DolphaGo/DolphaGo/issues/97)를 참고해보자. 스토리지 문제일 수 있다.
- 정상적으로 실행이 되었다면 다음과 같은 로그를 확인할 수 있다.

```
Loading dashboards (Kibana must be running and reachable)
2022-04-19T03:06:26.232+0900	INFO	kibana/client.go:119	Kibana url: http://localhost:5601
2022-04-19T03:06:27.342+0900	INFO	kibana/client.go:119	Kibana url: http://localhost:5601
2022-04-19T03:07:36.511+0900	INFO	instance/beat.go:815	Kibana dashboards successfully loaded.
Loaded dashboards
2022-04-19T03:07:36.511+0900	WARN	[cfgwarn]	instance/beat.go:556	DEPRECATED: Setting up ML using Filebeat is going to be removed. Please use the ML app to setup jobs. Will be removed in version: 8.0.0
Setting up ML using setup --machine-learning is going to be removed in 8.0.0. Please use the ML app instead.
See more: https://www.elastic.co/guide/en/machine-learning/current/index.html
2022-04-19T03:07:36.511+0900	INFO	eslegclient/connection.go:99	elasticsearch url: http://localhost:9200
2022-04-19T03:07:36.513+0900	INFO	[esclientleg]	eslegclient/connection.go:314	Attempting to connect to Elasticsearch version 7.10.2
2022-04-19T03:07:36.513+0900	INFO	kibana/client.go:119	Kibana url: http://localhost:5601
2022-04-19T03:07:36.528+0900	WARN	fileset/modules.go:421	X-Pack Machine Learning is not enabled
Loaded machine learning job configurations
2022-04-19T03:07:36.529+0900	INFO	eslegclient/connection.go:99	elasticsearch url: http://localhost:9200
2022-04-19T03:07:36.531+0900	INFO	[esclientleg]	eslegclient/connection.go:314	Attempting to connect to Elasticsearch version 7.10.2
2022-04-19T03:07:36.531+0900	INFO	cfgfile/reload.go:262	Loading of config files completed.
Loaded Ingest pipelines
```

- 엘라스틱서치 인덱스 템플릿, 수명주기 정책과 같은 인덱스 관리 정보와 인제스트 파이프라인, 그리고 키바나 샘플 대시보드까지 설치하기 때문에 셋업하는데 시간이 조금 걸릴 것이다.
- 실행이 완료되었다면, 키바나의 **대시보드**에 `filebeat-*`의 인덱스들이 생성이 되고 관련된 샘플 대시보드들이 추가된다.
![](/images/2022-04-19-03-07-59.png)

- 파일비트와 엘라스틱서치, 키바나 간의 셋업이 끝나면 이제 마지막으로 파일 비트를 실행해보자

```sh
./filebeat -e
```

- `-e` 옵션은 오류나 로그를 확인하기 위함이다.
- 키바나 > Management > Stack Management > Index Management 로 이동한다.

![](/images/2022-04-19-03-10-16.png)
- 현재 클러스터의 인덱스들을 확인할 수 있는데, `filebeat-*` 라는 이름의 인덱스가 보일 것이다.
- 우리가 직접 만들진 않았찌만, 파일비트에서 setup 과정을 통해 만들어졌다.

또한 로그를 직접 확인해볼 수 있다. Kibana > Discover로 가보자.
![](/images/2022-04-19-03-16-40.png)


## 파일비트 설정

- 파일비트를 설치한 폴더를 보면 `filebeat.reference.yml`이라는 파일이 있다.
- 파일비트의 모든 설정에 대한 설명과 기본값이 적혀있는 참조 파일이다.
- 버전에 맞춰 추가/삭제된 옵션이 모두 포함되어있으니, 설정파일을 수정할 때 참고하자.

### 유용한 설정

#### ignore_older

- `ignore_older` 는 새로운 파일 탐색 시 오래된 파일을 읽어들이지 않고 무시하기 위한 설정이다.
```yml
...
  #------------------------------ Log input --------------------------------
  - type: log
    enabled: true
    paths:
      - /Users/user/dev/elasticsearch-7.10.2/logs/*.log
    ignore_older: 24h
...
```
- ignore_older는 인풋 타입이 log인 경우 사용할 수 있는 옵션으로, ignore_older 값은 10h(10시간), 10m(10분) 처럼 타임스트링 형식으로 작성한다.
  - 예를 들어, ignore_older를 10h로 설정하면 최근 10시간 전의 로그만 수집하겠다는 의미이다.
- ignore_older의 기본값은 0으로, 특별히 값을 명시하지 않으면, 파일의 생성/수정 시간과 무관하게 모든 내용을 읽어들인다.


```yml
filebeat.inputs:
  - type: log
    enabled: true
    paths:
      - /Users/user/dev/elasticsearch-7.10.2/logs/*.log
    exclude_lines: ['^DBG']
    include_lines: ['^ERR', '^WARN']
    exclude_files: ['.gz$']

    ...
```

#### include_lines

- 특정 라인이나 파일을 추가/제외하는 옵션
- 특정 라인을 정규식을 이용해 필터링하고 매칭된 라인만 비츠에서 수집한다.
  - 파일비트 수준에서 복잡한 정제 작업을 수행할 수는 없지만, 간단한 정제 작업을 비츠에서 처리하면 엘라스틱 서치나 로그스태시에서 처리하는 작업량을 줄일 수 있다.
- 여기에서 ERR이나 WARN으로 시작하는 로그 라인은 파일비트가 수집한다.
  
#### exclude_lines

- 특정 라인을 정규식 표현식을 이용해 필터링하고, 매칭된 라인은 비츠에서 수집하지 않는다.
- 여기서 DBG로 시작하는 로그 라인은 파일비트 내부에서 버린다.

#### exclude_files

- 패턴에 일치하는 파일을 무시할 때 사용한다.
- 여기에서 확장자가 gz인 파일은 무시한다.
- 특정 폴더 내부에 분석해야 하는 로그 파일과 분석하지 않아도 되는 파일들이 섞여 있을 때 유용하게 사용할 수 있다.


### 멀티라인 로그처리
## 모듈
### 비트다운로드
### 비츠 설정 파일 수정
### 모듈 활성화
### 모듈 설정 파일 수정
### setup 명령과 함께 비트 실행
### 키바나에서 확인
