## Deployment

> 쿠버네티스가 어떻게 무중단 배포를 할 수 있을까?

배포 방법에는 다음과 같이 3가지 방법이 있다.

1. 이전 파드들을 모두 삭제하고, 새로운 파드를 등록한 뒤 트래픽을 옮기기

- 이 방법은 다음과 같은 문제가 있다.
- 이전 파드들을 삭제하고, 새 파드가 시작되는 동안 짧은 시간의 다운타임이 생기게 된다.
- 이 짧은 시간의 다운 타임을 허용한다면, 이는 파드를 업데이트 하는 가장 간단한 방법이 된다.

2. Blue & Green 배포
- 다운 타임을 발생시키지 않고 한번에 여러 버전의 애플리케이션 전환을 할 수 있는 방법
- 먼저 새 파드를 모두 기동한 후에 이전 파드들의 트래픽을 변경해주고, 기존 파드를 내리는 방법
- 잠시동안 동시에 2배의 파드가 실행되므로 더 많은 하드웨어 리소스가 필요하다.

3. 롤링 업데이트
- 파드를 단계별로 교체
- 이전 레플리케이션 컨트롤러(레플리카 셋)를 천천히 스케일 다운하고, 새 파드를 스케일 업해서 이를 수행한다.
- 파드 셀렉터에 이전 파드와 새 파드를 모두 포함하게 하여 요청을 두 파드 세트로 보낼 수 있다.
- 수동 롤링 업데이트는 오류가 발생하기 쉽다. (올바른 순서로 수 많은 명령어를 실행해서, 순차적으로 롤링을 진행해야 한다.)
- 그러나 쿠버네티스를 이용하면, 하나의 명령어로 롤링업데이트를 수행할 수 있다.
  - `kubectl rolling-update` {as is rs} {to be rs} --image={image path}
  - 즉, 교체할 레플리케이션 컨트롤러(레플리카 셋)를 알려주고, 새 레플리케이션컨트롤러(레플리카 셋)의 이름을 지정한 다음, 새로 교체할 이미지를 지정해주면 된다.
- 그러나 kubectl이라는 클라이언트로 쿠버네티스의 리소스가 변경이 일어난다는 점은 좋지 못하다.


> 동일한 이미지 태그로 업데이트 푸시하기
- 애플리케이션을 수정하고 동일한 이미지 태그로 푸시하는 것이 좋은 선택은 아니긴 하지만 개발 중에는 그럴 수 있다.
- 워커 노드에서 일단 이미지를 한 번 가져오면, 이미지는 노드에 저장되고, 동일한 이미지를 사용해 새 파드를 실행할 때 이미지를 다시 가져오지 않는다. (이것이 이미지를 가져오는 기본 정책이 된다.)
- 즉, 변경한 내용을 같은 이미지 태그로 푸시하면 이미지가 변경되지 않는다.
- 새 파드가 동일한 노드로 스케줄된 경우엔 kubelet은 이전 버전의 이미지를 실행한다.
- 이런 일이 일어나지 않길 원한다면, imagePullPolicy 속성을 `Always`로 변경해야 한다.
- 기본 imagePullPolicy는 이미지 태그에 따라 드랃.
- 컨테이너가 latest 태그를 명시적으로(latest를 명시적으로 지정하거나, 태그를 지정하지 않을 때) 참조하는 경우에 imagePullPolicy의 기본값은 Always이지만, 컨테이너가 다른 태그를 참조할 땐 기본 값은 IfNotPresent가 된다.
- 그래서 가장 좋은 방법은 이미지를 변경할 때마다 새로운 태그를 적용하는 것이다.


> 롤링업데이트가 진행되는 과정

- 서비스의 파드 셀렉터가 app=dolphago라고 가정, 그리고 기존 파드들은 app=dolphago, deployment=abc-123456라고 가정한다.
- 기존 레플리카셋의 셀렉터가 app=dolphago, deployment=abc-123456 이라서 기존 파드들과 묶여있는 상황.
- 그런데 새로운 레플리카셋이 app=dolphago, deployment=zxc-12345 가 된다면, 새로 생성되는 파드들의 레이블은 app=dolphago, deployment=zxc-12345가 생성될 것,
- 그러나 서비스에서는 파드 셀렉터가 app=dolphago이기 때문에 새로운 파드들에게도 트래픽이 전달될 수 있다.
- 루프를 반복하면서 기존 파드를 내리고, 새로운 파드를 올리는 과정을 반복한다.
- 서비스는 롤링업데이트 중의 요청의 이전 파드와 새로운 파드 모두에 전달할 수 있게 된다.
- kubectl이 롤링업데이트를 계속하면 새로운 파드에 대한 요청 비율이 점점 높아지기 시작한다.
- 모두 롤링업데이트가 되었다면, kubectl은 이전 레플리카셋을 삭제하고 롤링업데이트는 완료된다.