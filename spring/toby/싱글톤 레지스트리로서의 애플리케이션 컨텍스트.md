**애플리케이션 컨텍스트는 싱글톤을 저장하고 관리하는 싱글톤 레지스트리**이다.

스프링은 기본적으로 별 다른 설정을 하지 않으면, 내부에서 생성하는 빈 오브젝트를 모두 싱글톤으로 만든다.

## 서버 애플리케이션과 싱글톤
- 스프링이 싱글톤으로 빈을 만드는 이유?
  - 스프링이 주로 적용되는 대상이 자바 엔터프라이즈 기술을 사용하는 서버환경이기 때문
  - 태생적으로 스프링은 엔터프라이즈 시스템을 위해 고안된 기술이기 때문에 서버 환경에서 사용될 때 그 가치가 있다. (실제로 스프링은 대부분 서버 환경에서 사용된다.)
  - 스프링은 초기에 초당 수십에서 수백번씩 브라우저나 다른 시스템으로부터 요청을 받아 처리할 수 있도록 높은 성능이 요구되는 환경이었다.
  - 요청 1번에 5개의 오브젝트가 만들어져야 하고, 요청마다 새로운 오브젝트가 만들어진다면, 초당 500개 요청이 들어오면 2500개의 새로운 오브젝트가 생성된다. 
  - 1분이면 15만개, 한시간이면 900만개의 새로운 오브젝트가 만들어진다. 아무리 GC가 좋아졌다한들 이 정도로 부하가 걸리면 서버가 감당하기 힘들다.
  - 그래서 엔터프라이즈 분야에서는 `서비스 오브젝트`라는 개념을 이전부터 사용해왔다.
  - 여기서 서블릿은 자바 엔터프라이즈 기술의 가장 기본이 되는 서비스 오브젝트이다.
  - 서블릿은 대부분 멀티스레드 환경에서 싱글톤으로 동작한다.
  - 서블릿 클래스당 하나의 오브젝트만 만들어두고, 사용자의 요청을 담당하는 여러 스레드에서 하나의 오브젝트를 공유하여 동시에 사용한다.
  - 이렇게 애플리케이션 안에 제한된 수, 대개 한개의 오브젝트만 만들어서 사용하는 것이 바로 **싱글톤 패턴의 원리**가 된다.
  

## 싱글톤 패턴의 한계

> 일반적인 자바에서 싱글톤을 구현하는 방법
- 클래스 밖에서는 오브젝트를 생성하지 못하도록 생성자를 `private`으로 한다.
- 생성된 싱글톤 오브젝트를 저장할 수 있는 자신과 같은 타입의 스태틱 필드를 정의한다.
- 스태틱 팩토리 메소드인 getInstance()를 만들고, 이 메소드가 **최초로 호출되는 시점에 한 번만 오브젝트가 만들어지게** 한다. 이렇게 생성된 오브젝트는 static field에 저장된다. 또는 static field의 초기값으로 오브젝트를 미리 만들어둘 수도 있겠다.
- 한 번 오브젝트(싱글톤)가 만들어지고 난 뒤에는 getInstance() 메서드를 통해 이미 만들어져 static field에 저장해둔 오브젝트를 넘겨준다.


> **그렇다면 이런 싱글톤의 한계는 무엇일까?**
- **private 생성자를 갖고 있기 때문에 상속할 수가 없다는 점**
  - 싱글톤 패턴은 생성자를 private 패턴으로 제한한다. 오직 싱글톤 클래스 자신만이 오브젝트를 만들도록 제한하기 때문이다.
  - private 생성자를 가진 클래스는 다른 생성자가 없다면 상속이 불가능하다는 점이다.
  - 즉, 객체지향의 장점인 상속과 이를 이용한 다형성을 적용할 수가 없다.
- **싱글톤은 테스트하기가 힘들다.**
  - 테스트에서 사용될 때 mock object 등으로 대체하기 가힘들다. (만들어지는 방식이 제한적이기 때문)
  - 싱글톤은 초기화 과정에서 생성자 등을 통해 사용할 오브젝트를 다이내믹하게 주입하기도 힘들기 때문에 필요한 오브젝트는 직접 오브젝트를 만들어서 사용할 수밖에 없다.
- **서버환경에서는 싱글톤이 하나만 만들어진다는 것을 보장하지 못한다.**
  - 서버에서 클래스 로더를 어떻게 구성하고 있냐에 따라서 싱글톤 클래스임에도 하나 이상의 오브젝트가 만들어질 수가 있다.
  - 따라서 자바 언어를 이용한 싱글톤 패턴 기법은 서버환경에서는 싱글톤이 꼭 보장된다고는 할 수 없다. 
  - 여러개의 JVM에 분산되서 설치가 되는 경우에도 각각 독립적으로 오브젝트가 생기기 때문에 싱글톤으로서의 가치가 떨어진다.

- **싱글톤의 사용은 전역 상태를 만들 수 있기 때문에 바람직하지 못하다.**
  - 싱글톤의 스태틱 메서드를 이용해서 싱글톤에 언제든지 쉽게 접근할 수가 있기때문에 애플리케이션 어디서든지 사용할 수가 있다.
  - 그러다보면 자연스럽게 전역 상태로서 사용되기가 쉽다.
  - 아무 객체나 자유롭게 접근/수정/공유할 수 있는 전역 상태를 갖는 것은 객체지향 프로그래밍에서는 권장되지 않는 프로그래밍 모델이다.
  - 싱글톤을 사용하다보면 이러한 유혹에 빠지기 쉬우니, 이럴 바에 아예 스태틱 필드와 메서드로만 구성된 클래스를 사용하는 것이 낫다.


## 싱글톤 레지스트리
- 스프링은 서버환경에서 싱글톤이 만들어져서 서비스 오브젝트 방식으로 사용되는 것은 권장되나, 자바의 기본적인 싱글톤 패턴 구현은 여러 단점이 있기에 스프링은 직접 싱글톤 형태의 오브젝트를 만들고 관리하는 기능을 제공한다.
- **이것이 바로 싱글톤 레지스트리**이다.
- 스프링 컨테이너는 싱글톤을 생성하고, 관리하고, 공급하는 싱글톤 관리 컨테이너이기도 하다.

### 싱글톤 레지스트리의 장점
- static method와 private 생성자를 사용해야 하는 비정상적인 클래스가 아니라, 평범한 자바 클래스를 싱글톤으로 활용하게 해준다는 점.
- 평범한 자바클래스라도 IoC 방식의 컨테이너를 사용해서 생성과 관계설정, 사용 등에 대한 제어권을 컨테이너에게 넘기면 손쉽게 싱글톤 방식으로 만들어져 관리되게 할 수 있다. 오브젝트 생성에 관한 모든 권한은 IoC 기능을 제공하는 애플리케이션 컨텍스트에 있기 때문이다.

`==> 스프링의 싱글톤 레지스트리 덕분에 싱글톤 방식으로 사용될 애플리케이션 클래스라도 public 생성자를 가질 수 있게 된다.` 

따라서 테스트 환경에서 자유롭게 오브젝트를 만들 수가 있고, 테스트를 위한 mock object로 대체하는 것도 간단해진다.

`가장 중요한 것은, 싱글톤 패턴과 달리, 스프링이 지지하는 객체지향적인 설계 방식과 원칙, 디자인 패턴(싱글톤 패턴 제외) 등을 적용하는데 있어서 아무런 제약이 없다는 점이다. 스프링은 IoC 컨테이너 일 뿐만 아니라, 고전적인 싱글톤 패턴을 대신해서 싱글톤을 만들고 관리해주는 싱글톤 레지스트리라는 점을 기억해두길 바란다.`

- 요약하면, 스프링이 빈을 싱글톤으로 만드는 것은 결국 오브젝트의 생성방법을 제어하는 IoC 컨테이너로서의 역할이다.
  


## 싱글톤과 오브젝트의 상태
- 싱글톤은 멀티스레드 환경이라면 여러 스레드가 동시에 접근해서 사용할 수가 있다. 따라서 상태 관리를 잘해야 한다.
- **멀티스레드 환경에서 서비스 형태의 오브젝트로 사용되는 경우에는 상태정보를 내부에 갖고 있지 않은 stateless 방식으로 만들어져야 한다.**
- 즉, 싱글톤은 기본적으로 인스턴스의 필드의 값을 변경하고 유지하는 stateful한 방식으로는 만들지 않는다.
- 상태가 없는 방식으로 클래스를 만드는 경우에 각 요청에 대한 정보나, DB나 서버의 리소스로부터 생성한 정보는 파라미터와 로컬변수, 리턴 값등을 이용하면 된다. 
- 메서드 안에서 생성되는 로컬 변수는 매번 새로운 값을 저장할 독립적인 공간이 만들어지기 때문에 싱글톤이라고 해도 여러 스레드가 변수의 값을 덮어쓸 일은 없다.
- 즉, 싱글톤으로 사용하는 클래스 내부에 매번 새로운 값으로 바뀌는 정보가 되는 것들을 인스턴스 변수로 담으면 문제가 생긴다.(상태가 변하는 것들)
- 그러나, 읽기 전용 인스턴스 변수라면 괜찮다.(이런 것들은 static final이나 final을 붙여주자)

## 스프링 빈의 스코프
- 스프링이 관리하는 오브젝트, 즉 **빈**이 생성되고 존재하고, 적용되는 범위를 **스코프**라고 한다.
- 스프링 빈의 기본 스코프는 싱글톤이다
- 싱글톤 스코프는 컨테이너 내에 한 개의 오브젝트만 만들어져서, 강제로 제거하지 않는 한 스프링 컨테이너가 존재하는 동안 계속 유지된다.
- 프로토타입 스코프, 웹스코프(request scope, session scope 등)도 있다. 이런 것들은 추후 10장에서 알아보도록 하자.
